package k8s

import (
	"k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/client-go/kubernetes"
	"k8s.io/client-go/tools/clientcmd"
)

func GetK8sClient(k8sConf string) (*kubernetes.Clientset, error) {
	config, err := clientcmd.RESTConfigFromKubeConfig([]byte(k8sConf))
	if err != nil {
		return nil, err
	}

	//kubeConfPath:= filepath.Join(os.Getenv("HOME"), ".kube", "config")
	//config, err = clientcmd.BuildConfigFromFlags("", kubeConfPath)
	//if err != nil {
	//	return nil, err
	//}

	clientSet, err := kubernetes.NewForConfig(config)
	if err != nil {
		return nil, err
	}
	return clientSet, nil
}

func IsK8sHealth(k8sConf string) error {
	clientSet, err := GetK8sClient(k8sConf)
	if err != nil {
		return err
	}
	_, err = clientSet.CoreV1().Nodes().List(v1.ListOptions{})
	//nodeList, err = clientSet.CoreV1().Nodes().List(v1.ListOptions{})
	if err != nil {
		return err
	}
	//fmt.Printf("%#v\n", nodeList)
	// &v1.NodeList{TypeMeta:v1.TypeMeta{Kind:"", APIVersion:""}, ListMeta:v1.ListMeta{SelfLink:"/api/v1/nodes", ResourceVersion:"2449", Continue:""}, Items:[]v1.Node{v1.Node{TypeMeta:v1.TypeMeta{Kind:"", APIVersion:""}, ObjectMeta:v1.ObjectMeta{Name:"kubernetes-server", GenerateName:"", Namespace:"", SelfLink:"/api/v1/nodes/kubernetes-server", UID:"7fe54afd-231e-4da8-93c2-09514c786d2b", ResourceVersion:"2435", Generation:0, CreationTimestamp:v1.Time{Time:time.Time{wall:0x0, ext:63748370253, loc:(*time.Location)(0x34ef1e0)}}, DeletionTimestamp:(*v1.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string{"beta.kubernetes.io/arch":"amd64", "beta.kubernetes.io/os":"linux", "kubernetes.io/arch":"amd64", "kubernetes.io/hostname":"kubernetes-server", "kubernetes.io/os":"linux", "node-role.kubernetes.io/master":""}, Annotations:map[string]string{"flannel.alpha.coreos.com/backend-data":"null", "flannel.alpha.coreos.com/backend-type":"host-gw", "flannel.alpha.coreos.com/kube-subnet-manager":"true", "flannel.alpha.coreos.com/public-ip":"10.151.3.99", "kubeadm.alpha.kubernetes.io/cri-socket":"/var/run/dockershim.sock", "node.alpha.kubernetes.io/ttl":"0", "volumes.kubernetes.io/controller-managed-attach-detach":"true"}, OwnerReferences:[]v1.OwnerReference(nil), Initializers:(*v1.Initializers)(nil), Finalizers:[]string(nil), ClusterName:""}, Spec:v1.NodeSpec{PodCIDR:"10.244.0.0/24", ProviderID:"", Unschedulable:false, Taints:[]v1.Taint(nil), ConfigSource:(*v1.NodeConfigSource)(nil), DoNotUse_ExternalID:""}, Status:v1.NodeStatus{Capacity:v1.ResourceList{"cpu":resource.Quantity{i:resource.int64Amount{value:64, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"64", Format:"DecimalSI"}, "ephemeral-storage":resource.Quantity{i:resource.int64Amount{value:238659895296, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"", Format:"BinarySI"}, "hugepages-1Gi":resource.Quantity{i:resource.int64Amount{value:0, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"0", Format:"DecimalSI"}, "hugepages-2Mi":resource.Quantity{i:resource.int64Amount{value:0, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"0", Format:"DecimalSI"}, "memory":resource.Quantity{i:resource.int64Amount{value:201148764160, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"196434340Ki", Format:"BinarySI"}, "nvidia.com/gpu":resource.Quantity{i:resource.int64Amount{value:2, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"2", Format:"DecimalSI"}, "pods":resource.Quantity{i:resource.int64Amount{value:110, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"110", Format:"DecimalSI"}}, Allocatable:v1.ResourceList{"cpu":resource.Quantity{i:resource.int64Amount{value:64, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"64", Format:"DecimalSI"}, "ephemeral-storage":resource.Quantity{i:resource.int64Amount{value:238659895296, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"", Format:"BinarySI"}, "hugepages-1Gi":resource.Quantity{i:resource.int64Amount{value:0, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"0", Format:"DecimalSI"}, "hugepages-2Mi":resource.Quantity{i:resource.int64Amount{value:0, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"0", Format:"DecimalSI"}, "memory":resource.Quantity{i:resource.int64Amount{value:201148764160, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"196434340Ki", Format:"BinarySI"}, "nvidia.com/gpu":resource.Quantity{i:resource.int64Amount{value:2, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"2", Format:"DecimalSI"}, "pods":resource.Quantity{i:resource.int64Amount{value:110, scale:0}, d:resource.infDecAmount{Dec:(*inf.Dec)(nil)}, s:"110", Format:"DecimalSI"}}, Phase:"", Conditions:[]v1.NodeCondition{v1.NodeCondition{Type:"NetworkUnavailable", Status:"False", LastHeartbeatTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370274, loc:(*time.Location)(0x34ef1e0)}}, LastTransitionTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370274, loc:(*time.Location)(0x34ef1e0)}}, Reason:"FlannelIsUp", Message:"Flannel is running on this node"}, v1.NodeCondition{Type:"MemoryPressure", Status:"False", LastHeartbeatTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370925, loc:(*time.Location)(0x34ef1e0)}}, LastTransitionTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370252, loc:(*time.Location)(0x34ef1e0)}}, Reason:"KubeletHasSufficientMemory", Message:"kubelet has sufficient memory available"}, v1.NodeCondition{Type:"DiskPressure", Status:"False", LastHeartbeatTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370925, loc:(*time.Location)(0x34ef1e0)}}, LastTransitionTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370252, loc:(*time.Location)(0x34ef1e0)}}, Reason:"KubeletHasNoDiskPressure", Message:"kubelet has no disk pressure"}, v1.NodeCondition{Type:"PIDPressure", Status:"False", LastHeartbeatTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370925, loc:(*time.Location)(0x34ef1e0)}}, LastTransitionTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370252, loc:(*time.Location)(0x34ef1e0)}}, Reason:"KubeletHasSufficientPID", Message:"kubelet has sufficient PID available"}, v1.NodeCondition{Type:"Ready", Status:"True", LastHeartbeatTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370925, loc:(*time.Location)(0x34ef1e0)}}, LastTransitionTime:v1.Time{Time:time.Time{wall:0x0, ext:63748370280, loc:(*time.Location)(0x34ef1e0)}}, Reason:"KubeletReady", Message:"kubelet is posting ready status"}}, Addresses:[]v1.NodeAddress{v1.NodeAddress{Type:"InternalIP", Address:"10.151.3.99"}, v1.NodeAddress{Type:"Hostname", Address:"kubernetes-server"}}, DaemonEndpoints:v1.NodeDaemonEndpoints{KubeletEndpoint:v1.DaemonEndpoint{Port:10250}}, NodeInfo:v1.NodeSystemInfo{MachineID:"2c08e96719fa4b0e9bd3724043ade87a", SystemUUID:"00000000-0000-0000-0000-ac1f6b472d0a", BootID:"558c5eb4-664d-4953-b003-5923e95e33c4", KernelVersion:"4.18.0-193.6.3.el8_2.x86_64", OSImage:"CentOS Linux 8 (Core)", ContainerRuntimeVersion:"docker://19.3.4", KubeletVersion:"v1.18.5", KubeProxyVersion:"v1.18.5", OperatingSystem:"linux", Architecture:"amd64"}, Images:[]v1.ContainerImage{v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/gitlabci/golang@sha256:86a3ba51f60fcb7d4b33184fb5263c7113a6fa2bb6146c15d20a33341c8a1536", "registry.sensenebula.io:5000/gitlabci/golang:1.9-cuda-gcc49-1"}, SizeBytes:3287755137}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/logging/kibana@sha256:9812a93dd1e634a979cace128347f7177e770ea99dcd7ffc233b693543b552c8", "registry.sensenebula.io:5000/logging/kibana:7.9.3"}, SizeBytes:1176774068}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/logging/elasticsearch@sha256:c3aea057238cc8464bcfc9e5ac3fcc913999aae12488902b4254f8b99b68ba78", "registry.sensenebula.io:5000/logging/elasticsearch:7.9.3"}, SizeBytes:741516319}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/logging/logstash@sha256:719af2015601a76802ea51218c3d7409a06a2c8418996feb6bd94ce352f1551f", "registry.sensenebula.io:5000/logging/logstash:7.9.3"}, SizeBytes:734903631}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/logging/filebeat@sha256:760f1b74e81b5ae40a244035386bdfd2f7f8f72d45b248e3805f40cd8c11394d", "registry.sensenebula.io:5000/logging/filebeat:7.9.3"}, SizeBytes:449064937}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/nginx-ingress-controller@sha256:3872438389bda2d8f878187527d68b86dbdfb3c73ac67651186f5460e01c9073", "registry.sensenebula.io:5000/kubernetes/nginx-ingress-controller:0.30.0"}, SizeBytes:322915865}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/kube-apiserver@sha256:b3ae0c80512b5c6c76b03081c6672ffa7b81bd7fd2944f9b3883dc37291f8c23", "registry.sensenebula.io:5000/kubernetes/kube-apiserver:v1.18.5"}, SizeBytes:172989211}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/kube-controller-manager@sha256:3c97cbae181659778652f1d8e0ffed7d8aff76e6d5de677f3a3b26e6e9dabb97", "registry.sensenebula.io:5000/kubernetes/kube-controller-manager:v1.18.5"}, SizeBytes:162388763}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/kube-proxy@sha256:fcc8821250f310f11a99ddcff5df9c3056dd0aa558924d9f609d32e1b3bb8b4f", "registry.sensenebula.io:5000/kubernetes/kube-proxy:v1.18.5"}, SizeBytes:117090625}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/kube-scheduler@sha256:292eb07bdac7df135c75dba6da42ea72da9c2f1fa02991645cd8111d69f38746", "registry.sensenebula.io:5000/kubernetes/kube-scheduler:v1.18.5"}, SizeBytes:95275803}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/external_storage/local-volume-provisioner@sha256:1280eaefc25d3d89c2313cae92e68e9d2d71e036f4d0480f6ea3d48f2986e544", "registry.sensenebula.io:5000/external_storage/local-volume-provisioner:v2.3.0"}, SizeBytes:91255700}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/tiller@sha256:ece2efea209856b5202fe0f91991b59d9b590e5a782fdfb039bb6eabcff1e9b9", "registry.sensenebula.io:5000/kubernetes/tiller:v2.13.1"}, SizeBytes:82105090}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/nvidia/k8s-device-plugin@sha256:44414b67c753a9b751a9710870b7c1ca309d5c74e78184fd1d2a059f311aad2b", "registry.sensenebula.io:5000/nvidia/k8s-device-plugin:1.10"}, SizeBytes:63130377}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/coreos/flannel@sha256:2b4ae9c1adcaac1e44a64cde99f70a9914e851078ecdd6e5c23a56e7d23e1874", "registry.sensenebula.io:5000/coreos/flannel:v0.13.0-amd64"}, SizeBytes:57156911}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/coredns@sha256:f1972de99782dfb083d000e44b2dd7952c5c6ea826d6d2fbb65443653c948a09", "registry.sensenebula.io:5000/kubernetes/coredns:1.6.7"}, SizeBytes:43794147}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/defaultbackend-amd64@sha256:d08e129315e2dd093abfc16283cee19eabc18ae6b7cb8c2e26cc26888c6fc56a", "registry.sensenebula.io:5000/kubernetes/defaultbackend-amd64:1.5"}, SizeBytes:5132544}, v1.ContainerImage{Names:[]string{"registry.sensenebula.io:5000/kubernetes/pause@sha256:c9e90e530b13819560836142d7eff2d76c8ec259d9975164fe1c38bd99819e33", "registry.sensenebula.io:5000/kubernetes/pause:3.2"}, SizeBytes:682696}}, VolumesInUse:[]v1.UniqueVolumeName(nil), VolumesAttached:[]v1.AttachedVolume(nil), Config:(*v1.NodeConfigStatus)(nil)}}}}
	return nil
}
